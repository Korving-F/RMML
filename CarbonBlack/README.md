`CarbonBlackGen.py` will work by:

## 1. Build the IOCs
generate an array of `IOCv2`s ([link](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/watchlist-api/#iocs-1)) in the following format:

Because we're talking about CarbonBlack here and CarbonBlack sucks, we have to find some way to handle the ID generation. For now (at least) we'll say it's arbitrarily `sha1(b'query')[:12]`

```json
{
    "id": "465ea2da5354",
    "match_type": "query",
    "values": ["process_name:some_rmm.exe"],
    "link": "https://github.com/livinginsyn/RMML"
}
```

```python
>>> m = hashlib.sha1()
>>> m.update(b'process_name:malware.exe')
>>> m.hexdigest()[:12]
'465ea2da5354'
```

## 2. Generate or Update the private feed

Our Report ID will be statically defined as:
```python
>>> m = hashlib.sha1()
>>> m.update(b'i hate carbon blacks API')
>>> m.hexdigest()[:12]
'358aa2abf8d0'
```

### 2.a Does such a feed exist?
We will call the `Get All Feeds` API ([doc](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/feed-api#get-all-feeds)) and determine if one with our name exists. If yes, get the _report_ ID (note, not the feed ID, the REPORT id) and follow the update path for the feed.

### 2.b No feed exists
Docs link: [link](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/feed-api#create-a-new-private-feed) 

Object we have to create is:

```json
{
"feedinfo": {
    "name": "RMML-l - <exclusion>",
    "provider_url": "https://github.com/livinginsyn/RMML",
    "summary": "Remote Management and Monitoring Tool IOC List",
    "category": "external_threat_intel",
    "source_label": "RMML",
    "alertable": true
},
"reports": [{
    "id": "358aa2abf8d0",
    "timestamp": "<integer>",
    "title": "RMML-r - <exclusion>",
    "description": "Remote Management and Monitoring Tool IOC List",
    "severity": "7",
    "link": "https://github.com/livinginsyn/RMML",
    "tags": ["RMM"],
    "iocs_v2": ["<IOCv2>"],
    "visibility": "visible"
}]
}
```

This is generated by this CI and will be in a github release. Post the JSON object from the releases to:

```
{cbc-hostname}/threathunter/feedmgr/v2/orgs/{org_key}/feeds
```

We will take the `id` from this field and use it create the watchlist.

### 2.c Update an existing report (feed)
Docs link: [link](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/feed-api#update-report) 

If the feed exists than a report in it should also exist. We are not updating the _feed_ but updating the report inside of it. We are `PUT`ing an object with the following format to:

```
{cbc-hostname}/threathunter/feedmgr/v2/orgs/{org_key}/feeds/{feed_id}/reports/{report_id}
```

```json
{
   "id": "358aa2abf8d0",
   "timestamp": "<integer>",
   "title": "RMML-r - <exclusion>",
   "description": "Remote Management and Monitoring Tool IOC List",
   "severity": "7",
   "link": "https://github.com/LivingInSyn/RMML",
   "tags": ["RMM"],
   "iocs_v2": ["<IOCv2>"],
   "visibility": "visible"
}
```

## 3. Watchlist (so you get alerts)
Docs link: [link](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/watchlist-api/)

We will follow the same process as the feed. We'll check if ours exists, if not, we'll create it, if yes, we'll validate/update it

### 3.a Does the WL exist/Update it
First get all watchlists by making a `GET` request to:

```
{cbc-hostname}/threathunter/watchlistmgr/v3/orgs/{org_key}/watchlists
```

Iterate through the results searching for `RMML - <exclusion>` in the name field. If none exists go to step `3.b`. If it does exist, get the `id` from the same object.

If it exists make a `PUT` request to the following URL with the following object. This will "Update watchlist with watchlist_id. This will update the tags and alert status as well as any reports or classifiers attached to the watchlist."

```
{cbc-hostname}/threathunter/watchlistmgr/v3/orgs/{org_key}/watchlists/{watchlist_id}
```

```json
{
 "name": "RMML - <exclusion>",
 "description": "Remote Management and Monitoring Tool IOC List",
 "tags_enabled": "false",
 "alerts_enabled": "true",
 "alert_classification_enabled": "false",
 "report_ids": ["358aa2abf8d0"]
}
```

### 3.b Create a new watchlist
Docs link: [link](https://developer.carbonblack.com/reference/carbon-black-cloud/cb-threathunter/latest/watchlist-api/#create-new-watchlist)

To create a watchlist we will POST the following object to:
```
{cbc-hostname}/threathunter/watchlistmgr/v3/orgs/{org_key}/watchlists
```

```json
{
 "name": "RMML - <exclusion>",
 "description": "Remote Management and Monitoring Tool IOC List",
 "tags_enabled": "false",
 "alerts_enabled": "true",
 "alert_classification_enabled": "false",
 "report_ids": ["358aa2abf8d0"]
}
```
